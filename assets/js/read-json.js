(function(){var e,t,s,n,a;$(".sidebar").mCustomScrollbar({mouseWheel:{deltaFactor:100},autoHideScrollbar:!0}),a="data/",n="general/",t=new Vue({el:"#channelList",data:{channels:[]},methods:{onClick:function(t){return e.name=t.target.innerHTML.slice(1)},onLoad:function(){return e.name=this.channels[0].name},updateChannelList:function(){return $.getJSON(a+"channels.json",function(e){var s,n,a;for(s=0,n=e.length;n>s;s++)a=e[s],t.channels.push(a);return t.onLoad()})}},created:function(){return console.log("channelList created"),this.updateChannelList()}}),e=new Vue({el:"#channelInfo",data:{name:""},watch:{name:function(){return s.onChangeChannel()}}}),s=new Vue({el:"#channelMessages",data:{messages:[],messages_update:[],fileList:[],fileListNum:0,userData:[],loadMessage:!1},methods:{updateUserData:function(){var e;if(!(this.userData.length>0))return e=a+"users.json",console.log("load user data : "+e),$.ajax({type:"GET",url:e,async:!1}).done(function(e){return s.$set("userData",e)}),console.log("update user data done")},updateFileList:function(e){var t;return t=a+e+"/filelist.json",console.log("load channel filelist : "+t),$.ajax({type:"GET",url:t,async:!1}).done(function(e){return s.$set("fileList",e)}),console.log("update channel filelist done")},updateChannelMessages:function(e){var t;return console.log("update channel messages"),console.log("fileList.length : "+this.fileList.length),t=a+e+"/"+this.fileList[this.fileList.length-this.fileListNum],console.log("load json data : "+t),$.ajax({type:"GET",url:t,async:!1}).done(function(e){var t,n,a,o,i,l,u,r,c,d,h,m;for(r=[],n=0,i=e.length;i>n;n++){if(u=e[n],void 0===u.icons&&(void 0===u.user?u.icons={image_48:"assets/icon/dummy.png"}:s.userData.filter(function(e,t){return e.id===u.user?u.icons={image_48:e.profile.image_48}:void 0})),void 0===u.username&&(void 0===u.user?u.username="unknown":s.userData.filter(function(e,t){return e.id===u.user&&void 0!==e.name?u.username=e.name:void 0})),h=String(u.ts).split(".")[0],u.fixedTimestamp=moment.unix(h).format("YYYY/MM/DD hh:mm"),u.textFixed=marked(u.text),void 0!==u.attachments)for(c=u.attachments,a=0,l=c.length;l>a;a++)t=c[a],t.textFixed=marked(t.text);r.push(u)}for(d=[],o=r.length-1;o>=0;o+=-1)m=r[o],d.push(s.messages.unshift(m));return d}),console.log("update channel messages done")},onChangeChannel:function(){return this.$set("messages",[]),this.$set("messages_update",[]),this.updateUserData(),this.updateFileList(e.name),this.tryUpdateMessages(),document.documentElement.scrollTop=document.documentElement.scrollHeight},tryUpdateMessages:function(){for(console.log("checkNeedLoad: "+this.checkNeedLoad());this.messages.length<15&&this.fileListNum<this.fileList.length;)this.updateMessages();return this.$set("messages_update",this.messages)},updateMessages:function(){return this.updateChannelMessages(e.name),this.fileListNum++,console.log("fileListNum: "+this.fileListNum),console.log("checkNeedLoad: "+this.checkNeedLoad())},checkNeedLoad:function(){return 0===document.documentElement.scrollTop}},watch:{messages_update:function(){return console.log("messages updated")},loadMessage:function(){var e;return console.log("loadMessage: "+this.loadMessage),this.loadMessage===!0&&this.fileListNum<this.fileList.length?(e=document.documentElement.scrollHeight,this.updateMessages(),this.$set("messages_update",this.messages),document.documentElement.scrollTop=document.documentElement.scrollHeight-e):void 0}},created:function(){return console.log("channelMessages created")}}),document.onscroll=function(){return s.loadMessage=s.checkNeedLoad()}}).call(this);