(function(){var e,n,s,t;$(".sidebar").mCustomScrollbar({mouseWheel:{deltaFactor:100},autoHideScrollbar:!0}),t="data/",s="general/",e=new Vue({el:"#channelList",data:{channels:[]},methods:{onClick:function(e){return n.channel.name=e.target.innerHTML.slice(1),console.log("channel switched : "+n.channel.name)},onLoad:function(){return n.channel.name=this.channels[0].name,console.log("channel onLoad : "+n.channel.name)},updateChannelList:function(){return $.getJSON(t+"channels.json",function(n){var s,t,a;for(s=0,t=n.length;t>s;s++)a=n[s],e.channels.push(a);return e.onLoad()})}},created:function(){return console.log("channelList created"),this.updateChannelList()}}),n=new Vue({el:"#channelMassages",data:{channel:{name:""},massages:[],massages_updated:[],fileList:[],fileListNum:0,userData:[],loadMessage:!1},methods:{updateUserData:function(){var e;if(!(this.userData.length>0))return e=t+"users.json",console.log("load user data : "+e),$.ajax({type:"GET",url:e,async:!1}).done(function(e){return n.$set("userData",e)}),console.log("update user data done")},updateFileList:function(e){var s;return s=t+e+"/filelist.json",console.log("load channel filelist : "+s),$.ajax({type:"GET",url:s,async:!1}).done(function(e){return n.$set("fileList",e)}),console.log("update channel filelist done")},updateChannelMassages:function(e){var s;return console.log("update channel messages"),console.log("fileList.length : "+this.fileList.length),s=t+e+"/"+this.fileList[this.fileListNum],console.log("load json data : "+s),$.ajax({type:"GET",url:s,async:!1}).done(function(e){var s,t,a,o,i,l,u,c,d,r,h,g,m;for(d=[],t=0,i=e.length;i>t;t++){if(c=e[t],void 0===c.icons&&(void 0===c.user?c.icons={image_48:"assets/icon/dummy.png"}:n.userData.filter(function(e,n){return e.id===c.user?c.icons={image_48:e.profile.image_48}:void 0})),void 0===c.username&&(void 0===c.user?c.username="unknown":n.userData.filter(function(e,n){return e.id===c.user&&void 0!==e.name?c.username=e.name:void 0})),g=String(c.ts).split(".")[0],c.fixedTimestamp=moment.unix(g).format("YYYY/MM/DD hh:mm"),c.textFixed=marked(c.text),void 0!==c.attachments)for(r=c.attachments,a=0,l=r.length;l>a;a++)s=r[a],s.textFixed=marked(s.text);d.push(c)}for(h=[],o=0,u=d.length;u>o;o++)m=d[o],h.push(n.massages.push(m));return h}),console.log("update channel messages done")},onChangeChannel:function(){return this.$set("massages",[]),this.$set("massages_updated",[]),this.updateUserData(),this.updateFileList(this.channel.name),this.tryUpdateMessages()},tryUpdateMessages:function(){for(console.log("checkNeedLoad: "+this.checkNeedLoad());this.massages.length<15&&this.fileListNum<this.fileList.length;)this.updateMessages();return this.$set("massages_updated",this.massages)},updateMessages:function(){return this.updateChannelMassages(this.channel.name),this.fileListNum++,console.log("fileListNum: "+this.fileListNum),console.log("checkNeedLoad: "+this.checkNeedLoad())},checkNeedLoad:function(){var e,n,s;return s=document.documentElement.scrollTop||document.body.scrollTop,n=document.documentElement.offsetHeight||document.body.offsetHeight,e=document.documentElement.scrollHeight||document.body.scrollHeight,s+n+80>=e}},watch:{"channel.name":function(){return this.onChangeChannel()},massages_updated:function(){return console.log("massages updated")},loadMessage:function(){return console.log("loadMessage: "+this.loadMessage),this.loadMessage===!0&&this.fileListNum<this.fileList.length?(this.updateMessages(),this.$set("massages_updated",this.massages)):void 0}},created:function(){return console.log("channelMassages created")}}),document.onscroll=function(){return n.loadMessage=n.checkNeedLoad()}}).call(this);