(function(){var e,t,s,n,a;$(".sidebar").mCustomScrollbar({mouseWheel:{deltaFactor:100},autoHideScrollbar:!0}),a="data/",n="general/",t=new Vue({el:"#channelList",data:{channels:[]},methods:{onClick:function(t){return e.name=t.target.innerHTML.slice(1)},onLoad:function(){return e.name=this.channels[0].name},updateChannelList:function(){return $.getJSON(a+"channels.json",function(e){var s,n,a;for(s=0,n=e.length;n>s;s++)a=e[s],t.channels.push(a);return t.onLoad()})}},created:function(){return console.log("channelList created"),this.updateChannelList()}}),e=new Vue({el:"#channelInfo",data:{name:""},watch:{name:function(){return s.onChangeChannel()}}}),s=new Vue({el:"#channelMassages",data:{massages:[],massages_updated:[],fileList:[],fileListNum:0,userData:[],loadMessage:!1},methods:{updateUserData:function(){var e;if(!(this.userData.length>0))return e=a+"users.json",console.log("load user data : "+e),$.ajax({type:"GET",url:e,async:!1}).done(function(e){return s.$set("userData",e)}),console.log("update user data done")},updateFileList:function(e){var t;return t=a+e+"/filelist.json",console.log("load channel filelist : "+t),$.ajax({type:"GET",url:t,async:!1}).done(function(e){return s.$set("fileList",e)}),console.log("update channel filelist done")},updateChannelMassages:function(e){var t;return console.log("update channel messages"),console.log("fileList.length : "+this.fileList.length),t=a+e+"/"+this.fileList[this.fileListNum],console.log("load json data : "+t),$.ajax({type:"GET",url:t,async:!1}).done(function(e){var t,n,a,o,i,l,u,d,r,c,h,g,m;for(r=[],n=0,i=e.length;i>n;n++){if(d=e[n],void 0===d.icons&&(void 0===d.user?d.icons={image_48:"assets/icon/dummy.png"}:s.userData.filter(function(e,t){return e.id===d.user?d.icons={image_48:e.profile.image_48}:void 0})),void 0===d.username&&(void 0===d.user?d.username="unknown":s.userData.filter(function(e,t){return e.id===d.user&&void 0!==e.name?d.username=e.name:void 0})),g=String(d.ts).split(".")[0],d.fixedTimestamp=moment.unix(g).format("YYYY/MM/DD hh:mm"),d.textFixed=marked(d.text),void 0!==d.attachments)for(c=d.attachments,a=0,l=c.length;l>a;a++)t=c[a],t.textFixed=marked(t.text);r.push(d)}for(h=[],o=0,u=r.length;u>o;o++)m=r[o],h.push(s.massages.push(m));return h}),console.log("update channel messages done")},onChangeChannel:function(){return this.$set("massages",[]),this.$set("massages_updated",[]),this.updateUserData(),this.updateFileList(e.name),this.tryUpdateMessages()},tryUpdateMessages:function(){for(console.log("checkNeedLoad: "+this.checkNeedLoad());this.massages.length<15&&this.fileListNum<this.fileList.length;)this.updateMessages();return this.$set("massages_updated",this.massages)},updateMessages:function(){return this.updateChannelMassages(e.name),this.fileListNum++,console.log("fileListNum: "+this.fileListNum),console.log("checkNeedLoad: "+this.checkNeedLoad())},checkNeedLoad:function(){var e,t,s;return s=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.offsetHeight||document.body.offsetHeight,e=document.documentElement.scrollHeight||document.body.scrollHeight,s+t+80>=e}},watch:{massages_updated:function(){return console.log("massages updated")},loadMessage:function(){return console.log("loadMessage: "+this.loadMessage),this.loadMessage===!0&&this.fileListNum<this.fileList.length?(this.updateMessages(),this.$set("massages_updated",this.massages)):void 0}},created:function(){return console.log("channelMassages created")}}),document.onscroll=function(){return s.loadMessage=s.checkNeedLoad()}}).call(this);